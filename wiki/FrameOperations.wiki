#summary Каркасные преобразования.

Трубопровод является жесткой конструкцией и, следовательно, при изменении положения в пространстве одного из джоинта, необходимо соответственно повернуть присоединенные к данному сегменту ветки.

В общем случае изменение координат точек каркаса задается матрицей трансформации *T*. В свою очередь, матрица *Т* определяется комбинацией матриц поворота и смещений.

Рассмотрим изменивший свое положение в пространстве джоинт. Пусть к нему присоединена одна ветка, от которой отходят еще несколько. Следуя "деревянной" терминологии, назовем такую конструкцию "куст" :). 
Итак, для того, чтобы правильно повернуть куст, необходимо вычислить матрицу поворота *R*, которая будет одинакова для всех веток в составе куста. Расчет производится на основании старых и новых координат родительского сегмента - есть два вектора, определяется угол между ними и ортогональный им третий вектор, вокруг которого происходит поворот.

Далее рассчитываются матрицы смещений начальных точек для веток в составе куста причем для каждого джоинт-узла : смещение ветки к центру координат *VA*  и обратно *VS* c учетом новых координат точки присоединения ветки.

Т.о. общая матрица трансформации *T = VS x R x VA*  (смещение к центру, поворот, смещение на новое место).

_UPD: Не смотря на то, что данный алгоритм правильный и работает, его можно упростить! Ведь в общих каркасных преобразованиях (Frame Operations) вычисляется и применяется одна общая матрица для всех веток в составе трубопровода. Складывается впечатление, что локальные смещения учитываются за счет рекурсивного обхода и трансформации дерева._

В результате алгоритм действий таков:
  # Определяем матрицу трансформаций *Т*. Либо для измененного родительского джоинта (если таковых два - матриц также две и т.д.), либо для всей пипы в целом.
  # Каркасы всех веток в составе куста рекурсивно меняем на основании общей матрицы трансформации. И так для каждого куста.

----
PS: Граждане, записывайте своевременно свои мысли! Иногда в них полезно заглянуть :)))